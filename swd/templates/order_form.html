{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
    {% if messages %}
    <div class="section">
        {% for message in messages %}
        <div class="card-panel {% if message.tags == 'error' %}red{% else %}green{% endif %} lighten-4">
            <span class="{% if message.tags == 'error' %}red{% else %}green{% endif %}-text text-darken-2">
                <i class="material-icons left">{% if message.tags == 'error' %}error{% else %}check_circle{% endif %}</i>
                {{ message }}
            </span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Back to Store Button -->
    <div class="section">
        <a href="{% url 'store' %}" class="btn waves-effect waves-light" style="background-color: #F46036;">
            <i class="material-icons left">arrow_back</i>Back to Store
        </a>
    </div>
    
    {% if bundle %}
    <div class="section">
        <div class="row">
            <div class="col s12">
                <div class="card order-form-card">
                    <div class="card-content">
                        <!-- Bundle Header -->
                        <div class="bundle-header">
                            <h4>{{ bundle.title }}</h4>
                            <p class="club-name">{{ club.clubName|default:club.username }}</p>
                            {% if bundle.description %}
                            <p class="bundle-description">{{ bundle.description }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Order Form -->
                        <form method="POST" id="orderForm">
                            {% csrf_token %}
                            
                            <!-- Student Information -->
                            <div class="student-info-section">
                                <h5>Student Information</h5>
                                <div class="row">
                                    <div class="input-field col s12 m4">
                                        <input id="studentBITSID" name="studentBITSID" type="text" class="validate" required value="{{ student.bitsId|default:'' }}">
                                        <label for="studentBITSID">BITS ID</label>
                                    </div>
                                    <div class="input-field col s12 m4">
                                        <input id="studentName" name="studentName" type="text" class="validate" required value="{{ student.name|default:'' }}">
                                        <label for="studentName">Full Name</label>
                                    </div>
                                    <div class="input-field col s12 m4">
                                        <input id="studentEmail" name="studentEmail" type="email" class="validate" required value="{{ student.email|default:'' }}">
                                        <label for="studentEmail">Email</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Size Charts -->
                            {% if bundle.sizeCharts %}
                            <div class="size-charts-section">
                                <h5>Size Charts</h5>
                                <div class="row">
                                    {% for size_chart in bundle.sizeCharts %}
                                    <div class="col s12 m6 l4">
                                        <div class="size-chart-card">
                                            <img src="{{ size_chart }}" alt="Size Chart" class="responsive-img">
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Merch Items -->
                            {% if bundle.merchItems %}
                            <div class="merch-items-section">
                                <h5>Merch Items</h5>
                                <div class="row">
                                    {% for item in bundle.merchItems %}
                                    <div class="col s12 m6 l4">
                                        <div class="merch-item-card">
                                            {% if item.image %}
                                            <div class="item-image">
                                                <img src="{{ item.image }}" alt="{{ item.name }}" class="responsive-img">
                                            </div>
                                            {% endif %}
                                            <div class="item-header">
                                                <h6>{{ item.name }}</h6>
                                                <span class="price">₹{{ item.price }}</span>
                                            </div>
                                            {% if item.description %}
                                            <p class="item-description">{{ item.description }}</p>
                                            {% endif %}
                                            
                                            <div class="item-options">
                                                <div class="input-field">
                                                    <select name="items[{{ forloop.counter0 }}][size]" class="item-size">
                                                        <option value="One Size" selected>One Size</option>
                                                        <option value="XS">XS</option>
                                                        <option value="S">S</option>
                                                        <option value="M">M</option>
                                                        <option value="L">L</option>
                                                        <option value="XL">XL</option>
                                                        <option value="XXL">XXL</option>
                                                    </select>
                                                    <label>Size</label>
                                                </div>
                                                
                                                <div class="input-field">
                                                    <input id="quantity_{{ forloop.counter0 }}" name="items[{{ forloop.counter0 }}][quantity]" type="number" min="0" max="10" class="validate item-quantity" value="0">
                                                    <label for="quantity_{{ forloop.counter0 }}">Quantity (0-10)</label>
                                                </div>
                                                
                                                <input type="hidden" name="items[{{ forloop.counter0 }}][merchName]" value="{{ item.name }}">
                                                <input type="hidden" name="items[{{ forloop.counter0 }}][price]" value="{{ item.price }}">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Combos -->
                            {% if bundle.combos %}
                            <div class="combos-section">
                                <h5>Combos</h5>
                                <div class="row">
                                    {% for combo in bundle.combos %}
                                    <div class="col s12 m6 l4">
                                        <div class="combo-card">
                                            <div class="combo-header">
                                                <h6>{{ combo.name }}</h6>
                                                <span class="price">₹{{ combo.comboPrice }}</span>
                                            </div>
                                            {% if combo.description %}
                                            <p class="combo-description">{{ combo.description }}</p>
                                            {% endif %}
                                            
                                            <div class="combo-options">
                                                {% if combo.items %}
                                                <div class="combo-items-selection">
                                                    <label>Select Items:</label>
                                                    {% for item_name in combo.items %}
                                                    <div class="combo-item-option">
                                                        <div class="input-field">
                                                            <select name="combos[{{ forloop.parentloop.counter0 }}][items][{{ forloop.counter0 }}][size]" class="combo-item-size">
                                                                <option value="One Size" selected>One Size</option>
                                                                <option value="XS">XS</option>
                                                                <option value="S">S</option>
                                                                <option value="M">M</option>
                                                                <option value="L">L</option>
                                                                <option value="XL">XL</option>
                                                                <option value="XXL">XXL</option>
                                                            </select>
                                                            <label>{{ item_name }} - Size</label>
                                                        </div>
                                                        <input type="hidden" name="combos[{{ forloop.parentloop.counter0 }}][items][{{ forloop.counter0 }}][itemName]" value="{{ item_name }}">
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                                
                                                <div class="input-field">
                                                    <input id="combo_quantity_{{ forloop.counter0 }}" name="combos[{{ forloop.counter0 }}][quantity]" type="number" min="0" max="10" class="validate combo-quantity" value="0">
                                                    <label for="combo_quantity_{{ forloop.counter0 }}">Quantity (0-10)</label>
                                                </div>
                                                
                                                <input type="hidden" name="combos[{{ forloop.counter0 }}][comboName]" value="{{ combo.name }}">
                                                <input type="hidden" name="combos[{{ forloop.counter0 }}][price]" value="{{ combo.comboPrice }}">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Order Summary -->
                            <div class="order-summary">
                                <h5>Order Summary</h5>
                                <div class="summary-content">
                                    <div class="row">
                                        <div class="col s12 m8">
                                            <div id="order-items-list">
                                                <p style="color: #666; text-align: center;">No items selected</p>
                                            </div>
                                        </div>
                                        <div class="col s12 m4">
                                            <div class="total-section">
                                                <h6>Total Amount: <span id="total-amount">₹0</span></h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terms and Submit -->
                            <div class="order-submit">
                                <p>
                                    <input id="agree" type="checkbox" class="filled-in" required/>
                                    <label for="agree">I agree to place this order and understand that the amount will be deducted from my account</label>
                                </p>
                                <div class="submit-section">
                                    <button type="submit" id="place-order" class="btn waves-effect waves-light disabled" style="background-color: #F46036;">
                                        <i class="material-icons left">shopping_cart</i>Place Order
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="section">
        <div class="card-panel red lighten-4">
            <span class="red-text text-darken-2">
                <i class="material-icons left">error</i>
                Bundle not found or not available for ordering.
            </span>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .order-form-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .bundle-header {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #F46036 0%, #e74c3c 100%);
        color: white;
        margin: -25px -25px 25px -25px;
    }
    
    .bundle-header h4 {
        color: white !important;
        margin-bottom: 10px !important;
    }
    
    .club-name {
        font-size: 18px;
        margin: 10px 0;
        opacity: 0.9;
    }
    
    .bundle-description {
        font-size: 16px;
        line-height: 1.6;
        margin: 15px 0 0 0;
        opacity: 0.95;
    }
    
    .student-info-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .size-charts-section, .merch-items-section, .combos-section {
        margin: 30px 0;
    }
    
    .size-chart-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px solid #F46036;
        box-shadow: 0 4px 15px rgba(244, 96, 54, 0.1);
    }
    
    .merch-item-card, .combo-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .merch-item-card:hover, .combo-card:hover {
        border-color: #F46036;
        box-shadow: 0 4px 15px rgba(244, 96, 54, 0.2);
    }
    
    .item-image {
        text-align: center;
        margin-bottom: 15px;
    }
    
    .item-image img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .item-header, .combo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #F46036;
    }
    
    .item-header h6, .combo-header h6 {
        color: #F46036;
        font-weight: 600;
        margin: 0;
        font-size: 18px;
    }
    
    .price {
        background: #F46036;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .item-description, .combo-description {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin: 10px 0;
    }
    
    .combo-items-selection {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
    }
    
    .combo-item-option {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }
    
    .order-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 30px 0;
    }
    
    .summary-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #F46036;
    }
    
    .total-section {
        text-align: center;
        padding: 20px;
        background: #F46036;
        color: white;
        border-radius: 8px;
    }
    
    .total-section h6 {
        color: white !important;
        margin: 0;
        font-size: 20px;
    }
    
    .order-submit {
        text-align: center;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 30px 0;
    }
    
    .submit-section .btn {
        padding: 0 40px;
        height: 50px;
        line-height: 50px;
        font-size: 16px;
        border-radius: 25px;
        text-transform: none;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(244, 96, 54, 0.3);
        transition: all 0.3s ease;
    }
    
    .submit-section .btn:hover:not(.disabled) {
        box-shadow: 0 6px 20px rgba(244, 96, 54, 0.4);
        transform: translateY(-2px);
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .order-item-name {
        font-weight: 600;
        color: #F46036;
    }
    
    .order-item-details {
        color: #666;
        font-size: 14px;
    }
    
    .order-item-price {
        font-weight: 600;
        color: #333;
    }
    
    @media only screen and (max-width: 600px) {
        .bundle-header {
            padding: 20px;
        }
        
        .bundle-header h4 {
            font-size: 24px !important;
        }
        
        .merch-item-card, .combo-card {
            padding: 15px;
        }
        
        .item-header, .combo-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>

<script>
    $(document).ready(function() {
        // Initialize Materialize components
        $('select').material_select();
        
        // Update order summary when quantities change
        $('.item-quantity, .combo-quantity').on('change', function() {
            updateOrderSummary();
        });
        
        // Handle agreement checkbox
        $('#agree').change(function() {
            if ($(this).prop('checked')) {
                $('#place-order').removeClass('disabled');
            } else {
                $('#place-order').addClass('disabled');
            }
        });
        
        // Form submission
        $('#orderForm').on('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return false;
            }
            
            // Show loading state
            const $submitBtn = $('#place-order');
            $submitBtn.addClass('disabled').html('<i class="material-icons left">hourglass_empty</i>Processing...');
            
            // Collect form data as JSON
            const formData = {
                studentBITSID: $('#studentBITSID').val(),
                studentName: $('#studentName').val(),
                studentEmail: $('#studentEmail').val(),
                items: [],
                combos: []
            };
            
            // Collect items data
            $('.merch-item-card').each(function(index) {
                const quantity = parseInt($(this).find('.item-quantity').val()) || 0;
                if (quantity > 0) {
                    const price = parseFloat($(this).find('input[name*="[price]"]').val()) || 0;
                    const name = $(this).find('input[name*="[merchName]"]').val();
                    const size = $(this).find('.item-size').val() || 'One Size';
                    
                    formData.items.push({
                        merchName: name,
                        size: size,
                        quantity: quantity,
                        price: price
                    });
                }
            });
            
            // Collect combos data
            $('.combo-card').each(function(index) {
                const quantity = parseInt($(this).find('.combo-quantity').val()) || 0;
                if (quantity > 0) {
                    const price = parseFloat($(this).find('input[name*="[price]"]').val()) || 0;
                    const comboName = $(this).find('input[name*="[comboName]"]').val();
                    
                    const comboItems = [];
                    $(this).find('.combo-item-size').each(function() {
                        const itemName = $(this).closest('.combo-item-option').find('input[name*="[itemName]"]').val();
                        const size = $(this).val() || 'One Size';
                        comboItems.push({
                            itemName: itemName,
                            size: size
                        });
                    });
                    
                    formData.combos.push({
                        comboName: comboName,
                        quantity: quantity,
                        price: price,
                        items: comboItems
                    });
                }
            });
            
            // Send JSON data via AJAX
            console.log('Sending form data:', formData);
            $.ajax({
                url: window.location.href,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        M.toast({html: response.message, classes: 'green'});
                        setTimeout(function() {
                            window.location.href = '/store/';
                        }, 2000);
                    } else {
                        M.toast({html: response.message, classes: 'red'});
                        $submitBtn.removeClass('disabled').html('<i class="material-icons left">shopping_cart</i>Place Order');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    M.toast({html: 'An error occurred while placing your order. Please try again.', classes: 'red'});
                    $submitBtn.removeClass('disabled').html('<i class="material-icons left">shopping_cart</i>Place Order');
                }
            });
        });
        
        // Initialize order summary
        updateOrderSummary();
    });
    
    function validateForm() {
        let hasItems = false;
        let isValid = true;
        
        // Check if any items are selected
        $('.item-quantity, .combo-quantity').each(function() {
            const quantity = parseInt($(this).val()) || 0;
            if (quantity > 0) {
                hasItems = true;
            }
        });
        
        if (!hasItems) {
            M.toast({html: 'Please add at least one item to your order', classes: 'red'});
            return false;
        }
        
        if (!$('#agree').prop('checked')) {
            M.toast({html: 'Please agree to the terms before placing your order', classes: 'red'});
            return false;
        }
        
        return true;
    }
    
    function updateOrderSummary() {
        let totalAmount = 0;
        let orderItems = [];
        
        // Process merch items
        $('.merch-item-card').each(function(index) {
            const quantity = parseInt($(this).find('.item-quantity').val()) || 0;
            const price = parseFloat($(this).find('input[name*="[price]"]').val()) || 0;
            const name = $(this).find('input[name*="[merchName]"]').val();
            const size = $(this).find('.item-size').val() || 'One Size';
            
            if (quantity > 0) {
                const itemTotal = quantity * price;
                totalAmount += itemTotal;
                orderItems.push({
                    name: name,
                    size: size,
                    quantity: quantity,
                    price: price,
                    total: itemTotal
                });
            }
        });
        
        // Process combos
        $('.combo-card').each(function(index) {
            const quantity = parseInt($(this).find('.combo-quantity').val()) || 0;
            const price = parseFloat($(this).find('input[name*="[price]"]').val()) || 0;
            const comboName = $(this).find('input[name*="[comboName]"]').val();
            
            if (quantity > 0) {
                const itemTotal = quantity * price;
                totalAmount += itemTotal;
                
                // Get individual items in the combo
                const comboItems = [];
                $(this).find('.combo-item-size').each(function() {
                    const itemName = $(this).closest('.combo-item-option').find('input[name*="[itemName]"]').val();
                    const size = $(this).val();
                    if (size) {
                        comboItems.push(`${itemName} (${size})`);
                    }
                });
                
                orderItems.push({
                    name: comboName,
                    size: comboItems.join(', '),
                    quantity: quantity,
                    price: price,
                    total: itemTotal
                });
            }
        });
        
        // Update order items list
        let itemsHtml = '';
        orderItems.forEach(function(item) {
            itemsHtml += `
                <div class="order-item">
                    <div>
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-details">Size: ${item.size} | Quantity: ${item.quantity}</div>
                    </div>
                    <div class="order-item-price">₹${item.total}</div>
                </div>
            `;
        });
        
        if (orderItems.length === 0) {
            itemsHtml = '<p style="color: #666; text-align: center;">No items selected</p>';
        }
        
        $('#order-items-list').html(itemsHtml);
        $('#total-amount').text('₹' + totalAmount.toFixed(2));
    }
</script>
{% endblock %}

